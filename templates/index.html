<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ site_title }}</title>
    <meta name="description" content="{{ site_description }}">
    <meta name="keywords" content="nhập liệu, AI, tự động, biểu mẫu, thông minh, quản lý, excel">
    <meta property="og:title" content="{{ site_title }}">
    <meta property="og:description" content="{{ site_description }}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourdomain.com/">
    <meta property="og:image" content="/static/images/og-image.png">
    <link rel="icon" type="image/png" href="{{ site_logo }}">
    <link rel="icon" type="image/png" href="/static/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="{{ url_for('static', filename='js/field_editor.js') }}" defer></script>
    
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --secondary-color: #f8fafc;
            --accent-color: #f59e0b;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --success-color: #10b981;
            --error-color: #ef4444;
            --card-bg: rgba(255, 255, 255, 0.98);
            --back-button-color: #4f46e5;
            --excel-button-color: #16a34a;
        }

        .excel-upload-btn {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px -3px rgba(22, 163, 74, 0.4);
            background: linear-gradient(to right, var(--excel-button-color), #15803d);
        }
        
        .excel-upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -3px rgba(22, 163, 74, 0.5);
        }

        .excel-upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Improved Multi-select dropdown styles */
        .multi-select-container {
            position: relative;
            margin-top: 0.5rem;
        }

        .multi-select-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(203, 213, 225, 0.5);
            border-radius: 0.5rem;
            min-height: 3rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .multi-select-tags:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
        }

        .multi-select-tag {
            display: flex;
            align-items: center;
            background: var(--primary-color);
            color: white;
            padding: 0.4rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .multi-select-tag-remove {
            margin-left: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .multi-select-tag-remove:hover {
            color: #f87171;
            transform: scale(1.2);
        }

        .multi-select-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--card-bg);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 0.75rem;
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.15);
            max-height: 400px;
            overflow-y: auto;
            animation: slideDown 0.3s ease-out;
            padding: 0.5rem 0;
        }

        .multi-select-search {
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 0.75rem 1rem;
            background: var(--card-bg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .multi-select-search input {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(203, 213, 225, 0.5);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.2s ease;
        }

        .multi-select-search input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }

        .multi-select-header {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            background: rgba(79, 70, 229, 0.03);
            margin: 0.25rem 0.5rem;
            border-radius: 0.375rem;
        }

        .multi-select-header:hover {
            background: rgba(79, 70, 229, 0.08);
        }

        .multi-select-values {
            display: none;
            padding: 0.5rem 0;
            background: rgba(255, 255, 255, 0.95);
        }

        .multi-select-values.show {
            display: block;
        }

        .multi-select-option {
            padding: 0.75rem 2rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .multi-select-option:hover, .multi-select-option:focus {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
            outline: none;
        }

        .multi-select-option.selected {
            background: rgba(79, 70, 229, 0.15);
            font-weight: 500;
        }

        .multi-select-option input[type="checkbox"] {
            accent-color: var(--primary-color);
        }

        .multi-select-actions {
            position: sticky;
            bottom: 0;
            z-index: 10;
            padding: 0.75rem 1rem;
            background: var(--card-bg);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 0.5rem;
        }

        .multi-select-actions button {
            flex: 1;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .multi-select-actions .select-all {
            background: var(--primary-color);
            color: white;
        }

        .multi-select-actions .select-all:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .multi-select-actions .clear-all {
            background: #fef2f2;
            color: #dc2626;
        }

        .multi-select-actions .clear-all:hover {
            background: #fee2e2;
            transform: translateY(-1px);
        }

        .history-icon-container {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(203, 213, 225, 0.5);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .history-icon-container:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.2);
            transform: translateY(-50%) scale(1.05);
        }

        .history-icon-container.loading {
            background: var(--primary-color);
            color: white;
            cursor: wait;
        }

        .history-icon-container.loading i {
            animation: spin 1s linear infinite;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --excel-button-color: #22c55e;
                --primary-color: #6366f1;
                --primary-hover: #818cf8;
                --secondary-color: #1e293b;
                --text-primary: #f8fafc;
                --text-secondary: #94a3b8;
                --card-bg: rgba(15, 23, 42, 0.8);
                --back-button-color: #818cf8;
            }

            .excel-upload-btn {
                background: linear-gradient(to right, var(--excel-button-color), #15803d);
            }

            .multi-select-tags {
                background: rgba(15, 23, 42, 0.7);
                border-color: rgba(100, 116, 139, 0.3);
            }

            .multi-select-tag {
                background: var(--primary-hover);
            }

            .multi-select-dropdown {
                background: rgba(15, 23, 42, 0.95);
                border-color: rgba(100, 116, 139, 0.2);
            }

            .multi-select-search input {
                background: rgba(15, 23, 42, 0.7);
                border-color: rgba(100, 116, 139, 0.3);
                color: #f8fafc;
            }

            .multi-select-header {
                background: rgba(79, 70, 229, 0.1);
            }

            .multi-select-header:hover {
                background: rgba(79, 70, 229, 0.2);
            }

            .multi-select-values {
                background: rgba(15, 23, 42, 0.9);
            }

            .multi-select-option:hover, .multi-select-option:focus {
                background: rgba(79, 70, 229, 0.2);
            }

            .multi-select-option.selected {
                background: rgba(79, 70, 229, 0.3);
            }

            .multi-select-actions .select-all {
                background: var(--primary-hover);
            }

            .multi-select-actions .clear-all {
                background: #7f1d1d;
                color: #fecaca;
            }

            .history-icon-container {
                background: rgba(15, 23, 42, 0.9);
                border-color: rgba(100, 116, 139, 0.3);
                color: #f8fafc;
            }

            .history-icon-container:hover {
                background-color: var(--primary-hover);
                border-color: var(--primary-hover);
            }
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-family: 'Source Sans 3', 'Inter', sans-serif;
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .card-container {
            backdrop-filter: blur(16px);
            background: var(--card-bg);
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .card-container:hover {
            box-shadow: 0 25px 50px -15px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .header-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            position: relative;
            overflow: hidden;
            padding: 1.5rem 2rem;
        }
        
        .form-input-group label {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .form-input-group:focus-within label {
            color: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        .form-input {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(203, 213, 225, 0.5);
        }
        
        .form-input:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            transform: translateY(-1px);
            border-color: var(--primary-color);
        }
        
        .action-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1);
        }
        
        .suggestions-list {
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            background: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-top: 0.5rem;
            animation: fadeIn 0.2s ease-out;
        }
        
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: var(--text-primary);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .suggestion-item:hover {
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
        }
        
        .suggestion-value {
            flex: 1;
            font-weight: 500;
        }
        
        .suggestion-source {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .suggestion-header {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            background-color: rgba(79, 70, 229, 0.05);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        @media (prefers-color-scheme: dark) {
            .suggestions-list {
                background: rgba(15, 23, 42, 0.95);
                border-color: rgba(100, 116, 139, 0.2);
            }
            
            .suggestion-item:hover {
                background-color: rgba(79, 70, 229, 0.2);
            }
            
            .suggestion-source {
                background-color: rgba(255, 255, 255, 0.1);
            }
            
            .suggestion-header {
                background-color: rgba(79, 70, 229, 0.1);
                color: #f8fafc;
            }
        }
        
        .submit-button {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 25px -5px rgba(79, 70, 229, 0.4);
            background: linear-gradient(to right, var(--primary-color), var(--primary-hover));
            position: relative;
            overflow: hidden;
        }
        
        .submit-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px -5px rgba(79, 70, 229, 0.5);
        }
        
        .tooltip {
            transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
            opacity: 0;
            visibility: hidden;
            transform: translateY(5px);
        }
        
        .group:hover .tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .auto-fill-all-btn {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px -3px rgba(245, 158, 11, 0.4);
            background: linear-gradient(to right, var(--accent-color), #f97316);
        }
        
        .auto-fill-all-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -3px rgba(245, 158, 11, 0.5);
        }
        
        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(-5px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .form-input:focus, .form-input:active {
            transform: scale(1.01);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        
        .header-inner {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .form-section {
            padding: 2rem;
        }
        
        @media (max-width: 640px) {
            .form-section {
                padding: 1.5rem;
            }
            
            .card-container {
                border-radius: 1rem;
            }
            
            .header-gradient {
                padding: 1.5rem;
            }
            
            .back-button {
                position: relative;
                left: 0;
                top: 0;
                margin-bottom: 1rem;
                justify-content: center;
                width: 100%;
            }
            
            .header-content {
                padding-top: 0;
            }
        }
        
        .auto-fill-all-btn-ai {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px -3px rgba(124, 58, 237, 0.4);
            background: linear-gradient(to right, #7c3aed, #3b82f6);
        }

        .auto-fill-all-btn-ai:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -3px rgba(124, 58, 237, 0.5);
        }

        .back-button {
            position: absolute;
            left: 1.5rem;
            top: 1.5rem;
            display: flex;
            align-items: center;
            color: white;
            font-weight: 500;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .back-button:hover {
            transform: translateX(-2px);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .back-button i {
            margin-right: 0.5rem;
            transition: transform 0.2s ease;
        }
        
        .back-button:hover i {
            transform: translateX(-2px);
        }
        
        .input-button-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .input-button-group .form-input {
            flex: 1;
        }
        
        .form-input {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            width: 100%;
        }
        
        input.loading {
            background-image: none;
            padding-right: 1rem;
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <div class="card-container rounded-2xl overflow-hidden border border-gray-100/30 animate__animated animate__fadeIn">
            <div class="header-gradient relative">
                <a href="/dashboard" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                    <span>Trở về</span>
                </a>
                
                <div class="header-content flex flex-col items-center">
                    <svg class="w-12 h-12 text-white mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h1 class="text-3xl sm:text-4xl font-bold text-white text-center tracking-tight">{{ site_title }}</h1>
                    <p class="text-blue-100 text-center mt-3 text-base font-medium max-w-md">{{ site_description }}</p>
                </div>
            </div>
            
            <div class="form-section bg-white">
                <div class="mb-8 bg-indigo-50/50 border border-indigo-100 rounded-xl p-4 sm:p-5">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-indigo-800 flex items-center">
                                <i class="fas fa-magic mr-2"></i>
                                Chức năng thông minh
                            </h3>
                            <p class="text-sm text-indigo-600 mt-1">
                                Hệ thống AI sẽ tự động phân tích và điền các trường có thể, hoặc nhập từ file Excel
                            </p>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-3 items-center">
                            <button 
                                type="button" 
                                onclick="autoFillAllFields()" 
                                class="auto-fill-all-btn px-5 py-2.5 text-white rounded-lg transition-all flex items-center justify-center font-medium group relative overflow-hidden"
                            >
                                <span class="relative z-10 flex items-center">
                                    <span class="auto-fill-loading hidden mr-2">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </span>
                                    <span class="auto-fill-icon flex items-center">
                                        <i class="fas fa-bolt mr-2"></i>
                                        Điền tất cả tự động
                                    </span>
                                </span>
                            </button>
                            <label 
                                class="excel-upload-btn px-5 py-2.5 text-white rounded-lg transition-all flex items-center justify-center font-medium group relative overflow-hidden cursor-pointer"
                            >
                                <input type="file" accept=".xlsx,.xls" id="excel-upload" class="hidden" onchange="handleExcelUpload(event)">
                                <span class="relative z-10 flex items-center">
                                    <span class="excel-upload-loading hidden mr-2">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </span>
                                    <span class="excel-upload-icon flex items-center">
                                        <i class="fas fa-file-excel mr-2"></i>
                                        Tải lên Excel
                                    </span>
                                </span>
                            </label>
                            <button 
                                type="button" 
                                onclick="resetExcelData()" 
                                class="px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-all flex items-center justify-center font-medium"
                            >
                                <i class="fas fa-trash mr-2"></i>
                                Xóa dữ liệu Excel
                            </button>
                        </div>
                    </div>
                </div>
                
                <form action="/submit" method="post" class="space-y-6">
                    {% for field in fields %}
                    <div class="form-input-group">
                        <div class="flex justify-between items-center mb-2">
                            <label for="{{ field.field_code }}" class="block text-sm font-medium text-gray-700">{{ field.field_name }}</label>
                        </div>
                        
                        <div class="relative">
                            <div class="flex flex-col sm:flex-row gap-3">
                                <div class="flex-1 relative">
                                    <input 
                                        type="text" 
                                        id="{{ field.field_code }}" 
                                        name="{{ field.field_code }}" 
                                        class="form-input w-full px-4 py-3 pr-14 rounded-lg border border-gray-200 focus:ring-2 focus:ring-blue-200 text-gray-900 placeholder-gray-400"
                                        required
                                        placeholder="Nhập {{ field.field_name | lower }}"
                                        autocomplete="off"
                                        value="{{ field.value if field.value else '' }}"
                                        data-field-name="{{ field.field_name }}"
                                    >
                                    <span 
                                        class="history-icon-container" 
                                        data-field-code="{{ field.field_code }}" 
                                        title="Xem lịch sử giá trị"
                                        aria-label="Xem lịch sử giá trị của {{ field.field_name }}"
                                    >
                                        <i class="fas fa-history"></i>
                                    </span>
                                </div>
                                
                                <div class="button-group">
                                    <button 
                                        type="button" 
                                        onclick="rewriteFieldAI('{{ field.field_code }}')" 
                                        class="action-button rewrite px-4 py-2 bg-purple-50 hover:bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:hover:bg-purple-900/50 dark:text-purple-300 rounded-lg flex items-center justify-center shadow-sm focus:ring-2 focus:ring-purple-200 relative group"
                                        title="Viết lại bằng AI"
                                        aria-label="Viết lại nội dung cho {{ field.field_name }}"
                                    >
                                        <span class="rewrite-loading hidden">
                                            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        </span>
                                        <span class="rewrite-icon flex items-center">
                                            <i class="fas fa-pen"></i>
                                        </span>
                                        <div class="tooltip absolute invisible group-hover:visible bg-gray-800 text-white text-xs rounded py-1 px-2 -top-8 left-1/2 transform -translate-x-1/2 whitespace-nowrap">
                                            Viết lại nội dung bằng AI cho {{ field.field_name }}
                                        </div>
                                    </button>
                                    <button 
                                        type="button" 
                                        onclick="toggleMultiSelect('{{ field.field_code }}')" 
                                        class="action-button px-4 py-2 bg-green-50 hover:bg-green-100 text-green-600 dark:bg-green-900/30 dark:hover:bg-green-900/50 dark:text-green-300 rounded-lg flex items-center justify-center shadow-sm focus:ring-2 focus:ring-green-200 relative group"
                                        title="Chọn giá trị từ Excel"
                                        aria-label="Chọn giá trị từ Excel cho {{ field.field_name }}"
                                    >
                                        <span class="excel-select-loading hidden">
                                            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        </span>
                                        <span class="excel-select-icon flex items-center">
                                            <i class="fas fa-table"></i>
                                        </span>
                                        <div class="tooltip absolute invisible group-hover:visible bg-gray-800 text-white text-xs rounded py-1 px-2 -top-8 left-1/2 transform -translate-x-1/2 whitespace-nowrap">
                                            Chọn giá trị từ Excel cho {{ field.field_name }}
                                        </div>
                                    </button>
                                </div>
                            </div>
                            
                            <ul id="suggestions-{{ field.field_code }}" class="suggestions-list absolute z-10 w-full mt-2 rounded-lg border border-gray-100 hidden max-h-60 overflow-y-auto" role="listbox" aria-label="Lịch sử, gợi ý và giá trị Excel cho {{ field.field_name }}">
                            </ul>
                            
                            <div id="multi-select-{{ field.field_code }}" class="multi-select-container hidden">
                                <div class="multi-select-tags" id="multi-select-tags-{{ field.field_code }}" onclick="toggleMultiSelect('{{ field.field_code }}')">
                                    <span class="text-gray-500 text-sm p-2">Chọn giá trị...</span>
                                </div>
                                <div class="multi-select-dropdown hidden" id="multi-select-dropdown-{{ field.field_code }}">
                                    <div class="multi-select-search">
                                        <input type="text" placeholder="Tìm kiếm giá trị..." oninput="filterMultiSelectOptions('{{ field.field_code }}', this.value)">
                                    </div>
                                    <div class="multi-select-options"></div>
                                    <div class="multi-select-actions">
                                        <button type="button" class="select-all" onclick="selectAllValues('{{ field.field_code }}')">Chọn tất cả</button>
                                        <button type="button" class="clear-all" onclick="clearAllValues('{{ field.field_code }}')">Xóa tất cả</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="error-{{ field.field_code }}" class="hidden mt-2 text-red-500 text-sm"></div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="pt-8 flex flex-col sm:flex-row gap-4">
                        <a href="/dashboard" class="flex-1">
                            <button 
                                type="button" 
                                class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-3.5 rounded-lg focus:ring-4 focus:ring-gray-200 transition-all flex items-center justify-center space-x-2 font-semibold"
                            >
                                <i class="fas fa-arrow-left mr-2"></i>
                                <span>Trở về</span>
                            </button>
                        </a>
                        
                        <button 
                            type="button" 
                            onclick="saveAndGenerateDocx()" 
                            class="flex-1 submit-button text-white py-3.5 rounded-lg hover:from-blue-700 hover:to-blue-600 focus:ring-4 focus:ring-blue-200 transition-all flex items-center justify-center space-x-2 font-semibold"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Lưu và Tạo Tài Liệu</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="text-center mt-8 text-sm text-gray-500 animate__animated animate__fadeIn animate__delay-1s">
            <p>© 2025 Hệ Thống Nhập Liệu Thông Minh. Bản quyền thuộc về công ty chúng tôi.</p>
            <p class="mt-1 text-xs text-gray-400">Phiên bản 2.1.0 | Đã được cải tiến với AI và hỗ trợ Excel</p>
        </div>
    </div>

    <script>
        let historyCache = new Map();
        let excelDataCache = new Map();
        const DEBOUNCE_DELAY = 300;

        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function handleExcelUpload(event) {
            const fileInput = event.target;
            const file = fileInput.files[0];
            const button = fileInput.closest('label');
            const loadingIcon = button?.querySelector('.excel-upload-loading');
            const uploadIcon = button?.querySelector('.excel-upload-icon');

            if (!file) return;

            if (!loadingIcon || !uploadIcon || !button) {
                console.error('Excel upload button elements not found');
                showToast('Lỗi giao diện, vui lòng tải lại trang', 'error');
                return;
            }

            loadingIcon.classList.remove('hidden');
            uploadIcon.classList.add('hidden');
            button.disabled = true;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    if (jsonData.length <= 1) {
                        showToast('File Excel không chứa dữ liệu hoặc chỉ có tiêu đề', 'error');
                        throw new Error('No data in Excel file');
                    }

                    if (!jsonData[0] || jsonData[0].every(cell => cell == null)) {
                        showToast('Tiêu đề Excel không hợp lệ', 'error');
                        throw new Error('Invalid Excel headers');
                    }

                    excelDataCache.clear();
                    const excelDataObject = {};
                    jsonData.forEach((row, index) => {
                        if (index === 0) return;
                        row.forEach((cell, colIndex) => {
                            if (cell != null) {
                                const header = jsonData[0][colIndex] || `Cột ${colIndex + 1}`;
                                if (!excelDataObject[header]) {
                                    excelDataObject[header] = [];
                                }
                                excelDataObject[header].push(cell.toString());
                            }
                        });
                    });

                    console.log('Processed Excel data:', excelDataObject);

                    document.querySelectorAll('form input[type="text"]').forEach(input => {
                        input.dataset.excelValues = JSON.stringify(excelDataObject);
                        console.log(`Assigned Excel data to input ${input.id}:`, excelDataObject);
                    });

                    for (const [header, values] of Object.entries(excelDataObject)) {
                        excelDataCache.set(header, values);
                    }

                    showToast('Đã tải lên file Excel thành công', 'success');
                } catch (error) {
                    console.error('Error processing Excel:', error);
                    showToast('Có lỗi khi xử lý file Excel: ' + error.message, 'error');
                } finally {
                    loadingIcon.classList.add('hidden');
                    uploadIcon.classList.remove('hidden');
                    button.disabled = false;
                    fileInput.value = '';
                }
            };
            reader.onerror = function() {
                console.error('Error reading file');
                showToast('Không thể đọc file Excel', 'error');
                loadingIcon.classList.add('hidden');
                uploadIcon.classList.remove('hidden');
                button.disabled = false;
                fileInput.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        function toggleMultiSelect(fieldCode) {
            const multiSelectContainer = document.getElementById(`multi-select-${fieldCode}`);
            const dropdown = document.getElementById(`multi-select-dropdown-${fieldCode}`);
            const input = document.getElementById(fieldCode);
            const button = input.closest('.form-input-group').querySelector('button[onclick*="toggleMultiSelect"]');
            const errorDiv = document.getElementById(`error-${fieldCode}`);

            console.log(`Toggling multi-select for ${fieldCode}, excelValues:`, input.dataset.excelValues);

            const excelData = input.dataset.excelValues ? JSON.parse(input.dataset.excelValues) : {};
            if (Object.keys(excelData).length === 0) {
                errorDiv.textContent = 'Không có giá trị Excel nào được tải lên';
                errorDiv.classList.remove('hidden');
                showToast('Vui lòng tải lên file Excel trước', 'error');
                return;
            }

            errorDiv.classList.add('hidden');
            multiSelectContainer.classList.toggle('hidden');
            dropdown.classList.toggle('hidden');

            if (!dropdown.classList.contains('hidden')) {
                renderMultiSelectOptions(fieldCode);
                dropdown.querySelector('.multi-select-search input')?.focus();
            } else {
                dropdown.querySelectorAll('.multi-select-values').forEach(values => {
                    values.classList.remove('show');
                });
            }
        }

        function resetExcelData() {
            excelDataCache.clear();
            document.querySelectorAll('form input[type="text"]').forEach(input => {
                input.dataset.excelValues = '{}';
            });
            showToast('Đã xóa dữ liệu Excel', 'success');
        }

        function renderMultiSelectOptions(fieldCode, searchTerm = '') {
            const input = document.getElementById(fieldCode);
            const dropdown = document.getElementById(`multi-select-dropdown-${fieldCode}`);
            const tagsContainer = document.getElementById(`multi-select-tags-${fieldCode}`);
            const optionsContainer = dropdown.querySelector('.multi-select-options');
            const excelData = JSON.parse(input.dataset.excelValues || '{}');
            const selectedValues = input.value ? input.value.split(', ').filter(v => v) : [];

            optionsContainer.innerHTML = '';

            const headers = Object.keys(excelData).filter(header =>
                header.toLowerCase().includes(searchTerm.toLowerCase()) ||
                excelData[header].some(value => value.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            if (headers.length === 0) {
                const emptyOption = document.createElement('div');
                emptyOption.className = 'px-4 py-2 text-gray-500 text-center';
                emptyOption.textContent = 'Không tìm thấy giá trị phù hợp';
                optionsContainer.appendChild(emptyOption);
            } else {
                headers.forEach(column => {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'multi-select-header';
                    headerDiv.tabIndex = 0;
                    headerDiv.innerHTML = `
                        <span>${column}</span>
                        <i class="fas fa-chevron-down"></i>
                    `;
                    headerDiv.onclick = (e) => {
                        e.stopPropagation();
                        toggleHeaderValues(headerDiv);
                    };
                    headerDiv.onkeydown = (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggleHeaderValues(headerDiv);
                        } else if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            const nextHeader = headerDiv.nextElementSibling;
                            if (nextHeader) nextHeader.focus();
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            const prevHeader = headerDiv.previousElementSibling;
                            if (prevHeader) prevHeader.focus();
                        }
                    };

                    const valuesDiv = document.createElement('div');
                    valuesDiv.className = 'multi-select-values';
                    const values = excelData[column].filter(value =>
                        value.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    if (values.length === 0) {
                        const emptyOption = document.createElement('div');
                        emptyOption.className = 'multi-select-option';
                        emptyOption.textContent = 'Không có giá trị phù hợp';
                        valuesDiv.appendChild(emptyOption);
                    } else {
                        values.forEach(value => {
                            const option = document.createElement('div');
                            option.className = `multi-select-option ${selectedValues.includes(value) ? 'selected' : ''}`;
                            option.tabIndex = 0;
                            option.innerHTML = `
                                <input type="checkbox" ${selectedValues.includes(value) ? 'checked' : ''}>
                                <span>${value}</span>
                            `;
                            option.dataset.column = column;
                            option.onclick = (e) => {
                                e.stopPropagation();
                                toggleSelectValue(fieldCode, value);
                            };
                            option.onkeydown = (e) => {
                                if (e.key === 'Enter' || e.key === ' ') {
                                    e.preventDefault();
                                    toggleSelectValue(fieldCode, value);
                                } else if (e.key === 'ArrowDown') {
                                    e.preventDefault();
                                    const nextOption = option.nextElementSibling;
                                    if (nextOption) nextOption.focus();
                                } else if (e.key === 'ArrowUp') {
                                    e.preventDefault();
                                    const prevOption = option.previousElementSibling;
                                    if (prevOption) prevOption.focus();
                                    else headerDiv.focus();
                                } else if (e.key === 'Escape') {
                                    dropdown.classList.add('hidden');
                                    multiSelectContainer.classList.add('hidden');
                                    input.focus();
                                }
                            };
                            valuesDiv.appendChild(option);
                        });
                    }

                    optionsContainer.appendChild(headerDiv);
                    optionsContainer.appendChild(valuesDiv);
                });
            }

            renderSelectedTags(fieldCode, selectedValues);
        }

        function filterMultiSelectOptions(fieldCode, searchTerm) {
            debounce(() => renderMultiSelectOptions(fieldCode, searchTerm), DEBOUNCE_DELAY)();
        }

        function toggleHeaderValues(headerDiv) {
            const valuesDiv = headerDiv.nextElementSibling;
            if (valuesDiv) {
                valuesDiv.classList.toggle('show');
                headerDiv.parentElement.querySelectorAll('.multi-select-values').forEach(other => {
                    if (other !== valuesDiv) other.classList.remove('show');
                });
                const icon = headerDiv.querySelector('i');
                icon.className = valuesDiv.classList.contains('show') ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
                if (valuesDiv.classList.contains('show')) {
                    valuesDiv.querySelector('.multi-select-option')?.focus();
                }
            }
        }

        function toggleSelectValue(fieldCode, value) {
            const input = document.getElementById(fieldCode);
            let selectedValues = input.value ? input.value.split(', ').filter(v => v) : [];

            if (selectedValues.includes(value)) {
                selectedValues = selectedValues.filter(v => v !== value);
            } else {
                selectedValues.push(value);
            }

            input.value = selectedValues.join(', ');
            renderMultiSelectOptions(fieldCode);
        }

        function selectAllValues(fieldCode) {
            const input = document.getElementById(fieldCode);
            const excelData = JSON.parse(input.dataset.excelValues || '{}');
            const headers = Object.keys(excelData);
            let selectedValues = input.value ? input.value.split(', ').filter(v => v) : [];

            headers.forEach(column => {
                excelData[column].forEach(value => {
                    if (!selectedValues.includes(value)) {
                        selectedValues.push(value);
                    }
                });
            });

            input.value = selectedValues.join(', ');
            renderMultiSelectOptions(fieldCode);
            showToast('Đã chọn tất cả giá trị', 'success');
        }

        function clearAllValues(fieldCode) {
            const input = document.getElementById(fieldCode);
            input.value = '';
            renderMultiSelectOptions(fieldCode);
            showToast('Đã xóa tất cả giá trị', 'success');
        }

        function renderSelectedTags(fieldCode, selectedValues) {
            const tagsContainer = document.getElementById(`multi-select-tags-${fieldCode}`);
            tagsContainer.innerHTML = '';

            if (selectedValues.length === 0) {
                tagsContainer.innerHTML = '<span class="text-gray-500 text-sm p-2">Chọn giá trị...</span>';
            } else {
                selectedValues.forEach(value => {
                    const tag = document.createElement('div');
                    tag.className = 'multi-select-tag';
                    tag.innerHTML = `
                        <span>${value}</span>
                        <span class="multi-select-tag-remove" onclick="toggleSelectValue('${fieldCode}', '${value}')">✕</span>
                    `;
                    tagsContainer.appendChild(tag);
                });
                const countTag = document.createElement('div');
                countTag.className = 'multi-select-tag bg-gray-100 text-gray-600';
                countTag.textContent = `+${selectedValues.length} đã chọn`;
                tagsContainer.appendChild(countTag);
            }
        }

        function fetchFieldData(fieldCode, fieldName, inputValue = '') {
            if (historyCache.has(fieldCode)) {
                return Promise.resolve({ history: historyCache.get(fieldCode), suggestions: [] });
            }
            
            const iconContainer = document.querySelector(`.history-icon-container[data-field-code="${fieldCode}"]`);
            if (iconContainer) iconContainer.classList.add('loading');

            return fetch('/get_field_history', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ field_name: fieldName })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.history?.length >= 0) {
                    historyCache.set(fieldCode, data.history);
                    if (historyCache.size > 50) {
                        historyCache.delete(historyCache.keys().next().value);
                    }
                }
                return { history: data.history || [], suggestions: [] };
            })
            .finally(() => {
                if (iconContainer) iconContainer.classList.remove('loading');
            });
        }

        function renderSuggestions(input, container, data, inputValue = '') {
            container.innerHTML = '';
            const fieldCode = input.id;
            const fieldName = input.dataset.fieldName || fieldCode;
            const maxItems = 5;
            const excelData = JSON.parse(input.dataset.excelValues || '{}');

            const filterItems = (items) => {
                if (!inputValue.trim()) return items.slice(0, maxItems);
                return items
                    .filter(item => item.value.toLowerCase().includes(inputValue.toLowerCase()))
                    .slice(0, maxItems);
            };

            if (Object.keys(excelData).length > 0) {
                const excelHeader = document.createElement('li');
                excelHeader.className = 'suggestion-header';
                excelHeader.textContent = 'Giá trị từ Excel';
                container.appendChild(excelHeader);

                Object.keys(excelData).forEach(column => {
                    const filteredValues = filterItems(excelData[column].map(value => ({ value })));
                    filteredValues.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'suggestion-item';
                        li.tabIndex = 0;
                        li.role = 'option';
                        li.innerHTML = `
                            <span class="suggestion-value">${item.value}</span>
                            <span class="suggestion-source">${column}</span>
                        `;
                        li.onclick = () => selectSuggestion(input, container, item.value);
                        li.onkeydown = handleSuggestionKeyboardNavigation;
                        container.appendChild(li);
                    });
                });
            }

            if (data.history.length) {
                const historyHeader = document.createElement('li');
                historyHeader.className = 'suggestion-header';
                historyHeader.textContent = 'Lịch sử giá trị';
                container.appendChild(historyHeader);

                const filteredHistory = filterItems(data.history);
                filteredHistory.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'suggestion-item';
                    li.tabIndex = 0;
                    li.role = 'option';
                    li.innerHTML = `
                        <span class="suggestion-value">${item.value}</span>
                        <span class="suggestion-source">${new Date(item.timestamp).toLocaleDateString('vi-VN')}</span>
                    `;
                    li.onclick = () => selectSuggestion(input, container, item.value);
                    li.onkeydown = handleSuggestionKeyboardNavigation;
                    container.appendChild(li);
                });

                if (data.history.length > maxItems) {
                    const viewMore = document.createElement('li');
                    viewMore.className = 'suggestion-item text-blue-600 font-medium';
                    viewMore.tabIndex = 0;
                    viewMore.textContent = 'Xem thêm lịch sử...';
                    viewMore.onclick = () => {
                        console.log('Xem thêm lịch sử:', data.history);
                    };
                    viewMore.onkeydown = handleSuggestionKeyboardNavigation;
                    container.appendChild(viewMore);
                }
            }

            if (data.suggestions.length) {
                const suggestionsHeader = document.createElement('li');
                suggestionsHeader.className = 'suggestion-header';
                suggestionsHeader.textContent = 'Gợi ý AI';
                container.appendChild(suggestionsHeader);

                const filteredSuggestions = filterItems(data.suggestions);
                filteredSuggestions.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'suggestion-item';
                    li.tabIndex = 0;
                    li.role = 'option';
                    li.innerHTML = `
                        <span class="suggestion-value">${item.value}</span>
                        <span class="suggestion-source">AI (${Math.round(item.similarity * 100)}%)</span>
                    `;
                    li.onclick = () => selectSuggestion(input, container, item.value);
                    li.onkeydown = handleSuggestionKeyboardNavigation;
                    container.appendChild(li);
                });
            }

            if (!Object.keys(excelData).length && !data.history.length && !data.suggestions.length) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'suggestion-item text-gray-500';
                emptyItem.textContent = 'Không có lịch sử, gợi ý hoặc giá trị Excel';
                container.appendChild(emptyItem);
            }

            if (container.children.length > 0) {
                container.classList.remove('hidden');
                container.querySelector('li')?.focus();
            }
        }

        function selectSuggestion(input, container, value) {
            const currentValues = input.value ? input.value.split(', ').filter(v => v) : [];
            if (!currentValues.includes(value)) {
                currentValues.push(value);
                input.value = currentValues.join(', ');
                input.classList.add('bg-green-50', 'border-green-200');
                setTimeout(() => {
                    input.classList.remove('bg-green-50', 'border-green-200');
                }, 1000);
            }
            container.querySelector('li')?.focus();
        }

        function handleSuggestionKeyboardNavigation(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                e.target.click();
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                const next = e.target.nextElementSibling;
                if (next) next.focus();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prev = e.target.previousElementSibling;
                if (prev) prev.focus();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                e.target.closest('.suggestions-list').classList.add('hidden');
                e.target.closest('.form-input-group').querySelector('input').focus();
            }
        }

        function autoFillAllFields() {
            const inputs = document.querySelectorAll('form input[type="text"]');
            const button = document.querySelector('button[onclick="autoFillAllFields()"]');
            const loadingIcon = button?.querySelector('.auto-fill-loading');
            const fillIcon = button?.querySelector('.auto-fill-icon');

            if (loadingIcon) loadingIcon.classList.remove('hidden');
            if (fillIcon) fillIcon.classList.add('hidden');
            if (button) button.disabled = true;

            fetch('/auto_fill_all_fields', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.fields && typeof data.fields === 'object') {
                    let filledCount = 0;
                    const fieldsToFill = [];
                    
                    for (const fieldName in data.fields) {
                        const value = data.fields[fieldName];
                        const input = document.getElementById(fieldName);
                        const errorDiv = document.getElementById(`error-${fieldName}`);
                        
                        if (input && value) {
                            fieldsToFill.push({ input, value, fieldName });
                            if (errorDiv) errorDiv.classList.add('hidden');
                        }
                    }
                    
                    fieldsToFill.forEach(({ input, value, fieldName }) => {
                        const currentValues = input.value ? input.value.split(', ').filter(v => v) : [];
                        if (!currentValues.includes(value)) {
                            currentValues.push(value);
                            input.value = currentValues.join(', ');
                        }
                        input.classList.add('bg-yellow-50');
                        setTimeout(() => {
                            input.classList.remove('bg-yellow-50');
                        }, 2000);
                        filledCount++;
                    });
                    
                    if (filledCount > 0) {
                        showToast(`Đã tự động điền ${filledCount} trường`, 'success');
                    } else {
                        showToast('Không có trường nào được điền tự động', 'info');
                    }
                } else {
                    showToast('Không tìm thấy gợi ý để điền tự động', 'error');
                }
            })
            .catch(error => {
                console.error('Lỗi autofill toàn bộ:', error);
                showToast(error.error || 'Có lỗi xảy ra khi tự động điền tất cả.', 'error');
            })
            .finally(() => {
                if (loadingIcon) loadingIcon.classList.add('hidden');
                if (fillIcon) fillIcon.classList.remove('hidden');
                if (button) button.disabled = false;
            });
        }

        function rewriteFieldAI(fieldCode) {
            const input = document.getElementById(fieldCode);
            const formGroup = input.closest('.form-input-group');
            const button = formGroup.querySelector('button[onclick*="rewriteFieldAI"]');
            const loadingIcon = button?.querySelector('.rewrite-loading');
            const rewriteIcon = button?.querySelector('.rewrite-icon');
            const errorDiv = document.getElementById(`error-${fieldCode}`);

            if (!input.value.trim()) {
                errorDiv.textContent = 'Vui lòng nhập nội dung cần viết lại';
                errorDiv.classList.remove('hidden');
                showToast('Vui lòng nhập nội dung trước khi viết lại', 'error');
                return;
            }

            if (loadingIcon) loadingIcon.classList.remove('hidden');
            if (rewriteIcon) rewriteIcon.classList.add('hidden');
            if (button) button.disabled = true;
            if (errorDiv) errorDiv.classList.add('hidden');

            fetch('/AI_REWRITE', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    field_code: fieldCode,
                    user_input: input.value.trim(),
                    form_type: '{{ fields[0].form_type if fields else "" }}'
                })
            })
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw err; });
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                if (data.improved) {
                    input.value = data.improved;
                    showToast(`Đã viết lại nội dung cho "${data.field_name || input.dataset.fieldName}"`, 'success');
                    input.classList.add('bg-purple-50', 'border-purple-200');
                    setTimeout(() => {
                        input.classList.remove('bg-purple-50', 'border-purple-200');
                    }, 1000);
                } else {
                    errorDiv.textContent = data.message || 'Không thể cải thiện nội dung';
                    errorDiv.classList.remove('hidden');
                    showToast(errorDiv.textContent, 'error');
                }
            })
            .catch(error => {
                errorDiv.textContent = error.error || 'Có lỗi khi gọi AI viết lại';
                errorDiv.classList.remove('hidden');
                showToast(error.message || 'Có lỗi khi viết lại nội dung', 'error');
            })
            .finally(() => {
                if (loadingIcon) loadingIcon.classList.add('hidden');
                if (rewriteIcon) rewriteIcon.classList.remove('hidden');
                if (button) button.disabled = false;
            });
        }

        function handleKeyboardNavigation(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                e.target.click();
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                const next = e.target.nextElementSibling;
                if (next) next.focus();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prev = e.target.previousElementSibling;
                if (prev) prev.focus();
            } else if (e.key === 'Escape') {
                e.target.closest('.suggestions-list').classList.add('hidden');
                e.target.closest('.form-input-group').querySelector('input').focus();
            }
        }

        const debouncedInputHandler = debounce((input, suggestionsList) => {
            const fieldCode = input.id;
            const fieldName = input.dataset.fieldName || fieldCode;
            const errorDiv = document.getElementById(`error-${fieldCode}`);

            if (!suggestionsList.classList.contains('hidden')) {
                if (errorDiv) errorDiv.classList.add('hidden');
                fetchFieldData(fieldCode, fieldName, input.value)
                    .then(data => {
                        renderSuggestions(input, suggestionsList, data, input.value);
                    })
                    .catch(error => {
                        if (errorDiv) {
                            errorDiv.textContent = error.error || 'Có lỗi khi tải dữ liệu';
                            errorDiv.classList.remove('hidden');
                        }
                    });
            }
        }, DEBOUNCE_DELAY);

        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('form input[type="text"]');
            inputs.forEach(input => {
                const suggestionsList = document.getElementById(`suggestions-${input.id}`);
                input.addEventListener('input', () => debouncedInputHandler(input, suggestionsList));
            });

            document.querySelectorAll('.history-icon-container').forEach(icon => {
                icon.addEventListener('click', () => {
                    const fieldCode = icon.dataset.fieldCode;
                    const input = document.getElementById(fieldCode);
                    const suggestionsList = document.getElementById(`suggestions-${fieldCode}`);
                    const errorDiv = document.getElementById(`error-${fieldCode}`);

                    if (!suggestionsList.classList.contains('hidden')) {
                        suggestionsList.classList.add('hidden');
                        return;
                    }

                    document.querySelectorAll('.suggestions-list').forEach(dropdown => {
                        if (dropdown.id !== `suggestions-${fieldCode}`) {
                            dropdown.classList.add('hidden');
                        }
                    });

                    document.querySelectorAll('.multi-select-container').forEach(container => {
                        container.classList.add('hidden');
                        container.querySelector('.multi-select-dropdown')?.classList.add('hidden');
                    });

                    if (errorDiv) errorDiv.classList.add('hidden');
                    input.classList.add('loading');

                    fetchFieldData(fieldCode, input.dataset.fieldName, input.value)
                        .then(data => {
                            renderSuggestions(input, suggestionsList, data, input.value);
                        })
                        .catch(error => {
                            if (errorDiv) {
                                errorDiv.textContent = error.error || 'Có lỗi khi tải dữ liệu';
                                errorDiv.classList.remove('hidden');
                            }
                        })
                        .finally(() => {
                            input.classList.remove('loading');
                        });
                });
            });

            document.addEventListener('click', (e) => {
                if (!e.target.matches('input[type="text"]') && 
                    !e.target.closest('.suggestions-list') && 
                    !e.target.closest('.history-icon-container') && 
                    !e.target.closest('.multi-select-container') && 
                    !e.target.closest('.multi-select-dropdown')) {
                    document.querySelectorAll('.suggestions-list').forEach(dropdown => {
                        dropdown.classList.add('hidden');
                    });
                    document.querySelectorAll('.multi-select-container').forEach(container => {
                        container.classList.add('hidden');
                        container.querySelector('.multi-select-dropdown')?.classList.add('hidden');
                        container.querySelectorAll('.multi-select-values').forEach(values => {
                            values.classList.remove('show');
                        });
                    });
                }
            });
        });

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white font-medium animate__animated animate__fadeInUp ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.replace('animate__fadeInUp', 'animate__fadeOutDown');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        function saveAndGenerateDocx() {
            let isValid = true;
            document.querySelectorAll('form input[type="text"][required]').forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    const errorDiv = document.getElementById(`error-${input.id}`);
                    if (errorDiv) {
                        errorDiv.textContent = 'Vui lòng điền thông tin vào trường này';
                        errorDiv.classList.remove('hidden');
                    }
                }
            });
            
            if (isValid) {
                generateDocx();
            } else {
                showToast('Vui lòng điền đầy đủ các trường bắt buộc', 'error');
                const firstError = document.querySelector('[id^="error-"]:not(.hidden)');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function generateDocx() { 
            const button = event.target.closest('button');
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-2">Đang xử lý...</span>';

            const formData = new FormData();
            const form = document.querySelector('form');
            const inputs = form.querySelectorAll('input[type="text"]');

            inputs.forEach(input => {
                if (input.id && input.value) {
                    formData.append(input.id, input.value);
                }
            });
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            let documentName = 'Tài-liệu-' + timestamp;
            
            if (formData.get('contract_number')) {
                documentName = 'Hợp-đồng-' + formData.get('contract_number');
            } else if (formData.get('customer_name')) {
                documentName = 'Tài-liệu-' + formData.get('customer_name');
            }
            
            formData.append('document_name', documentName);

            fetch('/save-and-generate-docx', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                const contentType = response.headers.get('Content-Type');
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Có lỗi xảy ra khi tạo tài liệu');
                    });
                }
                if (!contentType || !contentType.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document')) {
                    throw new Error('Định dạng tài liệu không hợp lệ');
                }
                return response.blob().then(blob => ({ blob, headers: response.headers }));
            })
            .then(({ blob, headers }) => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                let filename = documentName + '.docx';
                
                const contentDisposition = headers.get('Content-Disposition');
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+?)"/i);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1];
                    }
                }
                
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                button.disabled = false;
                button.innerHTML = originalContent;
                showToast('Tài liệu đã được tạo và lưu thành công!', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                button.disabled = false;
                button.innerHTML = originalContent;
                showToast(error.message || 'Có lỗi xảy ra khi tạo tài liệu. Vui lòng thử lại.', 'error');
            });
        }
    </script>
</body>
</html>